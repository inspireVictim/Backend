# Техническая документация интеграции с Optima Bank

## Общая информация

**Версия протокола:** QIWI OSMP v1.4  
**URL эндпоинта:** `http://5.59.232.211:8000/api/v1/optima/payment`  
**Метод:** GET  
**Формат ответа:** XML (UTF-8)  
**Content-Type:** `application/xml; charset=utf-8`

---

## 1. Команда проверки счета (check)

### 1.1 Запрос

**Назначение:** Проверка существования и активности счета абонента перед проведением платежа.

**URL:**
```
GET /api/v1/optima/payment?command=check&txn_id={QID}&account={ACCOUNT}&sum={SUM}
```

**Параметры запроса:**

| Параметр | Тип | Обязательный | Описание | Формат/Ограничения |
|----------|-----|--------------|----------|-------------------|
| `command` | string | Да | Тип команды | `check` |
| `txn_id` | string | Да | Уникальный идентификатор транзакции (QID) | До 20 цифр (0-9) |
| `account` | string | Да | Идентификатор абонента в системе | 1-10 цифр (0-9) |
| `sum` | decimal | Да | Сумма платежа | Формат: `10.45` (с точкой, 2 знака после запятой) |

**Пример запроса:**
```
GET /api/v1/optima/payment?command=check&txn_id=12345678901234567890&account=12345&sum=100.50
```

### 1.2 Ответ

**Успешная проверка:**
```xml
<?xml version="1.0" encoding="UTF-8"?>
<response>
  <osmp_txn_id>12345678901234567890</osmp_txn_id>
  <sum>100.50</sum>
  <result>0</result>
  <comment>OK</comment>
</response>
```

**Элементы ответа:**

| Элемент | Обязательный | Описание |
|---------|--------------|----------|
| `osmp_txn_id` | Да | Уникальный идентификатор транзакции (QID), переданный в запросе |
| `sum` | Да | Сумма платежа (формат: `100.50`) |
| `result` | Да | Код результата операции (см. раздел "Коды ошибок") |
| `comment` | Да | Текстовое описание результата |

---

## 2. Команда пополнения баланса (pay)

### 2.1 Запрос

**Назначение:** Проведение платежа (пополнение баланса абонента).

**URL:**
```
GET /api/v1/optima/payment?command=pay&txn_id={QID}&account={ACCOUNT}&sum={SUM}&txn_date={TXN_DATE}
```

**Параметры запроса:**

| Параметр | Тип | Обязательный | Описание | Формат/Ограничения |
|----------|-----|--------------|----------|-------------------|
| `command` | string | Да | Тип команды | `pay` |
| `txn_id` | string | Да | Уникальный идентификатор транзакции (QID) | До 20 цифр (0-9) |
| `account` | string | Да | Идентификатор абонента в системе | 1-10 цифр (0-9) |
| `sum` | decimal | Да | Сумма платежа | Формат: `10.45` (с точкой, 2 знака после запятой) |
| `txn_date` | string | Нет | Дата и время транзакции | Формат: `yyyyMMddHHmmss` (14 цифр), пример: `20090815120133` |

**Пример запроса:**
```
GET /api/v1/optima/payment?command=pay&txn_id=12345678901234567890&account=12345&sum=100.50&txn_date=20241125143000
```

### 2.2 Ответ

**Успешное пополнение:**
```xml
<?xml version="1.0" encoding="UTF-8"?>
<response>
  <osmp_txn_id>12345678901234567890</osmp_txn_id>
  <prv_txn>42</prv_txn>
  <sum>100.50</sum>
  <result>0</result>
  <comment>OK</comment>
</response>
```

**Элементы ответа:**

| Элемент | Обязательный | Описание |
|---------|--------------|----------|
| `osmp_txn_id` | Да | Уникальный идентификатор транзакции (QID), переданный в запросе |
| `prv_txn` | Нет | Внутренний идентификатор транзакции в системе провайдера (возвращается только при успешной операции) |
| `sum` | Да | Сумма платежа (формат: `100.50`) |
| `result` | Да | Код результата операции (см. раздел "Коды ошибок") |
| `comment` | Да | Текстовое описание результата |

---

## 3. Коды ошибок (result)

| Код | Название | Описание |
|-----|----------|----------|
| `0` | OK | Операция успешно выполнена |
| `1` | TemporaryError | Временная ошибка. Необходимо повторить запрос позже |
| `4` | InvalidAccountFormat | Неверный формат идентификатора абонента (account) |
| `5` | AccountNotFound | Идентификатор абонента не найден в системе |
| `7` | PaymentForbidden | Прием платежей запрещен (отключен в настройках) |
| `79` | AccountNotActive | Счет абонента не активен (заблокирован или деактивирован) |
| `90` | PaymentNotCompleted | Проведение платежа не окончено |
| `241` | AmountTooSmall | Сумма платежа слишком мала (меньше минимально допустимой) |
| `242` | AmountTooLarge | Сумма платежа слишком велика (превышает максимально допустимую) |
| `243` | CannotCheckAccount | Невозможно проверить состояние счета (кошелек не найден) |
| `300` | OtherError | Другая ошибка провайдера |

**Пример ответа с ошибкой:**
```xml
<?xml version="1.0" encoding="UTF-8"?>
<response>
  <osmp_txn_id>12345678901234567890</osmp_txn_id>
  <sum>100.50</sum>
  <result>5</result>
  <comment>Пользователь не найден</comment>
</response>
```

---

## 4. Валидация параметров

### 4.1 txn_id (QID)

- **Формат:** Только цифры (0-9)
- **Максимальная длина:** 20 символов
- **Валидация:** `^\d+$` (регулярное выражение)
- **Пример правильного значения:** `12345678901234567890`
- **Пример неправильного значения:** `abc123`, `12-34-56`

**Ответ при ошибке:**
```xml
<response>
  <osmp_txn_id>abc123</osmp_txn_id>
  <sum>0</sum>
  <result>300</result>
  <comment>Неверный формат txn_id (до 20 цифр)</comment>
</response>
```

### 4.2 account (Идентификатор абонента)

- **Формат:** Только цифры (0-9)
- **Длина:** От 1 до 10 символов
- **Валидация:** `^[0-9]{1,10}$` (регулярное выражение)
- **Пример правильного значения:** `12345`
- **Пример неправильного значения:** `abc`, `12abc`, пустая строка

**Ответ при ошибке:**
```xml
<response>
  <osmp_txn_id>12345678901234567890</osmp_txn_id>
  <sum>0</sum>
  <result>4</result>
  <comment>Неверный формат идентификатора абонента</comment>
</response>
```

### 4.3 sum (Сумма платежа)

- **Формат:** Дробное число с точностью до сотых
- **Разделитель:** Точка (.)
- **Валидация:** `^\d+\.\d{2}$` (регулярное выражение)
- **Пример правильного значения:** `10.45`, `152.00`, `1.00`
- **Пример неправильного значения:** `10.5`, `10,45`, `10`, `abc`

**Ответ при ошибке:**
```xml
<response>
  <osmp_txn_id>12345678901234567890</osmp_txn_id>
  <sum>0</sum>
  <result>300</result>
  <comment>Неверный формат суммы (требуется формат: 10.45)</comment>
</response>
```

### 4.4 txn_date (Дата транзакции)

- **Формат:** `yyyyMMddHHmmss` (14 символов)
- **Пример:** `20090815120133` (15 августа 2009 года, 12:01:33)
- **Важно:** Параметр необязательный. Если не передан или имеет неверный формат, используется текущее время UTC.

---

## 5. IP-фильтрация

Система поддерживает IP-фильтрацию для безопасности. По умолчанию проверка IP включена.

**Настройка разрешенных IP-диапазонов:**
- Конфигурация в `appsettings.json`:
```json
{
  "OptimaPayment": {
    "IpCheckEnabled": true,
    "AllowedIpRanges": [
      "192.168.1.0/24",
      "10.0.0.0/8"
    ]
  }
}
```

**Поддержка CIDR нотации:**
- Одиночные IP: `192.168.1.100`
- Подсети: `192.168.1.0/24`, `10.0.0.0/8`

**Ответ при блокировке по IP:**
```xml
<?xml version="1.0" encoding="UTF-8"?>
<response>
  <osmp_txn_id>12345678901234567890</osmp_txn_id>
  <sum>0</sum>
  <result>300</result>
  <comment>Доступ запрещен</comment>
</response>
```
HTTP Status Code: `403 Forbidden`

---

## 6. Идемпотентность

Система гарантирует идемпотентность операций:

- **При повторном запросе с тем же `txn_id`:**
  - Если платеж уже успешно обработан, возвращается предыдущий успешный результат
  - Элемент `prv_txn` содержит идентификатор первоначальной транзакции

**Пример повторного запроса:**
```xml
<!-- Первый запрос -->
<response>
  <osmp_txn_id>12345678901234567890</osmp_txn_id>
  <prv_txn>42</prv_txn>
  <sum>100.50</sum>
  <result>0</result>
  <comment>OK</comment>
</response>

<!-- Повторный запрос с тем же txn_id -->
<response>
  <osmp_txn_id>12345678901234567890</osmp_txn_id>
  <prv_txn>42</prv_txn>
  <sum>100.50</sum>
  <result>0</result>
  <comment>Платеж уже был обработан ранее</comment>
</response>
```

---

## 7. Лимиты сумм

**Минимальная сумма:** Настраивается в конфигурации (по умолчанию: 1.00)  
**Максимальная сумма:** Настраивается в конфигурации (по умолчанию: 100000.00)

**Ответ при превышении лимитов:**
```xml
<!-- Сумма слишком мала -->
<response>
  <osmp_txn_id>12345678901234567890</osmp_txn_id>
  <sum>0.50</sum>
  <result>241</result>
  <comment>Минимальная сумма пополнения: 1.00</comment>
</response>

<!-- Сумма слишком велика -->
<response>
  <osmp_txn_id>12345678901234567890</osmp_txn_id>
  <sum>200000.00</sum>
  <result>242</result>
  <comment>Максимальная сумма пополнения: 100000.00</comment>
</response>
```

---

## 8. Логирование и сверка

**Все запросы логируются:**
- QID (txn_id)
- IP-адрес запрашивающей стороны
- User-Agent
- Raw запрос и ответ
- Статус обработки
- Коды ошибок

**Таблица для сверки:**
- `PaymentProviderTransactions` - хранит все запросы от банка
- Связь с внутренними транзакциями через `InternalTransactionId`
- Поддержка ручной и автоматической сверки

---

## 9. Порядок обработки команд

### 9.1 check

1. Проверка включения приема платежей
2. Валидация суммы (мин/макс)
3. Проверка существования пользователя
4. Проверка активности счета
5. Проверка существования кошелька
6. Сохранение запроса в БД
7. Возврат результата

### 9.2 pay

1. Проверка включения приема платежей
2. Проверка идемпотентности (дубликаты)
3. Валидация суммы (мин/макс)
4. Проверка существования пользователя
5. Проверка активности счета
6. Пополнение баланса
7. Сохранение транзакции в БД
8. Возврат результата

---

## 10. Примеры интеграции

### 10.1 cURL

```bash
# Проверка счета
curl "http://5.59.232.211:8000/api/v1/optima/payment?command=check&txn_id=12345678901234567890&account=12345&sum=100.50"

# Пополнение баланса
curl "http://5.59.232.211:8000/api/v1/optima/payment?command=pay&txn_id=12345678901234567890&account=12345&sum=100.50&txn_date=20241125143000"
```

### 10.2 PowerShell

```powershell
# Проверка счета
$url = "http://5.59.232.211:8000/api/v1/optima/payment"
$params = @{
    command = "check"
    txn_id = "12345678901234567890"
    account = "12345"
    sum = "100.50"
}
Invoke-RestMethod -Uri $url -Method Get -Body $params

# Пополнение баланса
$params = @{
    command = "pay"
    txn_id = "12345678901234567890"
    account = "12345"
    sum = "100.50"
    txn_date = "20241125143000"
}
Invoke-RestMethod -Uri $url -Method Get -Body $params
```

---

## 11. Рекомендации по интеграции

1. **Всегда сначала выполняйте команду `check` перед `pay`**
   - Это позволяет проверить валидность данных до проведения платежа
   - Уменьшает количество откатов транзакций

2. **Используйте уникальные `txn_id` для каждой транзакции**
   - Система поддерживает идемпотентность, но повторные запросы с тем же QID возвращают предыдущий результат

3. **Обрабатывайте все коды ошибок**
   - Даже временные ошибки (код 1) требуют повторной отправки запроса

4. **Логируйте все запросы и ответы**
   - Это поможет при сверке и отладке проблем

5. **Настройте IP-фильтрацию**
   - Предоставьте список ваших IP-адресов для добавления в `AllowedIpRanges`

---

## 12. Контакты и поддержка

**Техническая поддержка:**
- Email: [указать email]
- Телефон: [указать телефон]

**Мониторинг:**
- Health Check: `http://5.59.232.211:8000/api/v1/health`
- Swagger UI: `http://5.59.232.211:8000/swagger`

---

**Дата обновления документации:** 25 ноября 2024  
**Версия API:** v1  
**Версия протокола:** QIWI OSMP v1.4

